
SUBDIRS = srclib modules os server support

PROGRAM_NAME         = $(progname)
PROGRAM_SOURCES      = modules.c
PROGRAM_LDADD        = $(EXTRA_LDFLAGS) $(PROGRAM_DEPENDENCIES) $(EXTRA_LIBS)
PROGRAM_DEPENDENCIES = \
  $(BUILTIN_LIBS) \
  $(MPM_LIB) \
  server/libmain.la \
  os/$(OS_DIR)/libos.la \
  $(AP_LIBS)

PROGRAMS        = $(PROGRAM_NAME)
targets         = $(PROGRAMS) $(other_targets)
phony_targets   = $(srcdir)/buildmark.c
install_targets = install-conf install-htdocs install-icons install-other \
	install-cgi install-include install-support install-suexec
DISTCLEAN_TARGETS  = include/config_auto.h modules.c aclocal.m4 buildmk.stamp \
	configure generated_lists include/ap_config_auto.h \
	include/ap_config_auto.h.in include/ap_config_path.h install-sh \
	missing mkinstalldirs

include $(top_srcdir)/build/rules.mk
include $(top_srcdir)/build/program.mk

install-conf:
	@echo Installing configuration files
	@test -d $(sysconfdir) || $(MKINSTALLDIRS) $(sysconfdir)
	@cd docs/conf; \
	for i in mime.types magic; do \
		$(INSTALL_DATA) $$i $(sysconfdir); \
	done; \
	for i in *-std*; do \
		sed -e 's#@@ServerRoot@@#$(prefix)#g' \
		    -e 's#@@Port@@#$(PORT)#g' \
			< $$i > $(sysconfdir)/$$i; \
		chmod 0644 $(sysconfdir)/$$i; \
		file=`echo $$i|sed s/-std//`; \
		if [ "$$file" = "httpd.conf" ]; then \
			file=`echo $$file|sed s/.*.conf/$(PROGRAM_NAME).conf/`; \
		fi; \
		if test "$$file" != "$$i" && test ! -f $(sysconfdir)/$$file; then \
			$(INSTALL_DATA) $(sysconfdir)/$$i $(sysconfdir)/$$file; \
		fi; \
	done

htdocs-srcdir = docs/docroot

docs::
	mkdir -p ./docs/api
	srclib/apr/build/scandoc -isrclib/apr/build/default.pl -p./docs/api/ ./include/*.h

install-htdocs:
	@echo Installing HTML documents
	@test -d $(htdocsdir) || $(MKINSTALLDIRS) $(htdocsdir)
	@test -d $(htdocs-srcdir) && (cd $(htdocs-srcdir) && cp -rp * $(htdocsdir))
	@test -d $(htdocsdir)/manual || $(MKINSTALLDIRS) $(htdocsdir)/manual
	@test -d docs/manual && (cd docs/manual && cp -rp * $(htdocsdir)/manual)
	@(cd $(htdocsdir) && find . -name "CVS" -print | xargs rm -rf {} \;)

install-icons:
	@echo Installing icons
	@test -d $(iconsdir) || $(MKINSTALLDIRS) $(iconsdir)
	@(cd docs/icons && cp -rp * $(iconsdir))
	@(cd $(iconsdir) && find . -name "CVS" -print | xargs rm -rf {} \;)

install-cgi:
	@echo Installing CGIs
	@test -d $(cgidir) || $(MKINSTALLDIRS) $(cgidir)
	@(cd docs/cgi-examples && cp -rp * $(cgidir))
	@(cd $(cgidir) && find . -name "CVS" -print | xargs rm -rf {} \;)

install-support:
	@echo Installing Support Binaries
	@test -d $(bindir) || $(MKINSTALLDIRS) $(bindir)
	@cp -p $(srcdir)/support/httpd.exp $(bindir)
	@cp -p $(builddir)/support/htpasswd $(bindir)
	@cp -p $(builddir)/support/htdigest $(bindir)
	@cp -p $(builddir)/support/rotatelogs $(bindir)
	@cp -p $(builddir)/support/logresolve $(bindir)
	@cp -p $(builddir)/support/ab $(bindir)
	@cp -p $(builddir)/support/apachectl $(bindir)
	chmod 755 $(bindir)/apachectl
	@if test -f $(builddir)/support/apxs; then \
	    cp -p $(builddir)/support/apxs $(bindir); \
	    chmod 755 $(bindir)/apxs; \
	fi


install-other:
	@test -d $(logdir) || $(MKINSTALLDIRS) $(logdir)
	@for ext in dll x; do \
		file=apachecore.$$ext; \
		if test -f $$file; then \
			cp -p $$file $(bindir); \
		fi; \
	done;

install-include:
	@echo Installing header files
	@test -d $(includedir)     || $(MKINSTALLDIRS) $(includedir)
	@cp -p include/*.h $(srcdir)/include/*.h $(includedir)
	@cp -p $(srcdir)/os/$(OS_DIR)/os.h $(includedir)
	@if test -f $(srcdir)/os/$(OS_DIR)/os-inline.c; then \
            cp -p $(srcdir)/os/$(OS_DIR)/os-inline.c $(includedir); \
        fi;
	@cp -p $(srcdir)/server/mpm/$(MPM_NAME)/*.h $(includedir)
	@cp -p $(srcdir)/modules/dav/main/mod_dav.h $(includedir)
	@cp -p $(srcdir)/modules/filters/mod_include.h $(includedir)
	@cp -p $(srcdir)/srclib/expat-lite/*.h $(includedir)
	@cp -p $(srcdir)/srclib/pcre/*.h $(includedir)
	@cp -p $(srcdir)/srclib/apr/include/*.h $(includedir)
	@cp -p $(srcdir)/srclib/apr-util/include/*.h $(includedir)
	@cp -p $(srcdir)/os/$(OS_DIR)/*.h $(includedir)
	@chmod 644 $(includedir)/*.h

install-suexec:
	@if test -f $(builddir)/support/suexec; then \
            test -d $(sbindir) || $(MKINSTALLDIRS) $(sbindir); \
            cp -p $(srcdir)/support/suexec $(sbindir); \
	fi

suexec:
	cd support && make suexec
